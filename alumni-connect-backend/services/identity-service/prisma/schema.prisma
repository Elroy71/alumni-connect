// Identity Service Schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["multiSchema"]
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["identity_schema"]
}

// ==================== ENUMS ====================

enum Role {
  ALUMNI
  SUPER_ADMIN
  
  @@schema("identity_schema")
}

enum AccountStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
  
  @@schema("identity_schema")
}

enum Gender {
  MALE
  FEMALE
  
  @@schema("identity_schema")
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  DELETED

  @@schema("identity_schema")
}

// ==================== MODELS ====================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      Role     @default(ALUMNI)
  status    AccountStatus @default(ACTIVE)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?
  
  // Relations
  profile   Profile?
  posts     Post[]
  comments  Comment[]
  likes     Like[]

  // Job relations
  postedJobs      Job[]           @relation("JobPoster")
  applications    Application[]
  savedJobs       SavedJob[]

  // Event relations
  organizedEvents Event[]            @relation("EventOrganizer")
  registrations   Registration[]

  // Company relations
  createdCompanies Company[]      @relation("CompanyCreator")

  
  @@map("users")
  @@schema("identity_schema")
}

model Profile {
  id          String   @id @default(uuid())
  userId      String   @unique
  
  // Basic Info
  fullName    String
  nim         String?  @unique
  batch       String?
  major       String?
  graduationYear Int?
  
  // Personal Info
  gender      Gender?
  dateOfBirth DateTime?
  placeOfBirth String?
  
  // Contact Info
  phone       String?
  address     String?
  city        String?
  province    String?
  country     String?  @default("Indonesia")
  postalCode  String?
  
  // Social Media
  linkedinUrl String?
  githubUrl   String?
  portfolioUrl String?
  
  // Professional Info
  currentCompany String?
  currentPosition String?
  industry    String?
  yearsOfExperience Int?
  
  // Bio & Skills
  bio         String?
  skills      String[] @default([])
  interests   String[] @default([])
  
  // Photo
  avatar      String?
  coverImage  String?
  
  // Alumni Card
  cardNumber  String?  @unique
  qrCode      String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  experiences Experience[]
  education   Education[]
  skillsList  Skill[]
  achievements Achievement[]
  
  @@map("profiles")
  @@schema("identity_schema")
}

// ==================== PROFILE EXTENSION MODELS ====================

model Experience {
  id              String    @id @default(uuid())
  profileId       String
  title           String
  company         String
  location        String?
  employmentType  String?
  startDate       DateTime
  endDate         DateTime?
  isCurrentJob    Boolean   @default(false)
  description     String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  profile         Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  @@index([profileId])
  @@map("experiences")
  @@schema("identity_schema")
}

model Education {
  id              String    @id @default(uuid())
  profileId       String
  institution     String
  degree          String
  fieldOfStudy    String
  startDate       DateTime
  endDate         DateTime?
  isCurrentStudy  Boolean   @default(false)
  grade           String?
  activities      String?   @db.Text
  description     String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  profile         Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  @@index([profileId])
  @@map("education")
  @@schema("identity_schema")
}

model Skill {
  id                String    @id @default(uuid())
  profileId         String
  name              String
  level             String?
  yearsOfExperience Int?
  endorsements      Int       @default(0)
  createdAt         DateTime  @default(now())
  
  profile           Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  @@index([profileId])
  @@map("skills")
  @@schema("identity_schema")
}

model Achievement {
  id              String    @id @default(uuid())
  profileId       String
  title           String
  issuer          String
  issueDate       DateTime
  expiryDate      DateTime?
  credentialId    String?
  credentialUrl   String?
  description     String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  profile         Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  @@index([profileId])
  @@map("achievements")
  @@schema("identity_schema")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@map("refresh_tokens")
  @@schema("identity_schema")
}

// ==================== FORUM MODELS ====================

enum MediaType {
  IMAGE
  PDF
  DOCUMENT

  @@schema("identity_schema")
}

model Post {
  id          String      @id @default(uuid())
  userId      String
  title       String
  content     String      @db.Text
  excerpt     String?     @db.VarChar(200)
  coverImage  String?
  mediaType   MediaType?
  mediaUrl    String?     @db.Text
  categoryId  String?
  status      PostStatus  @default(PUBLISHED)
  views       Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  category    Category?   @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  comments    Comment[]
  likes       Like[]
  tags        PostTag[]

  @@index([userId])
  @@index([categoryId])
  @@index([status])
  @@index([createdAt])
  @@map("posts")
  @@schema("identity_schema")
}

model Comment {
  id          String      @id @default(uuid())
  postId      String
  userId      String
  content     String      @db.Text
  parentId    String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  post        Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent      Comment?    @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[]   @relation("CommentReplies")
  likes       Like[]

  @@index([postId])
  @@index([userId])
  @@index([parentId])
  @@map("comments")
  @@schema("identity_schema")
}

model Like {
  id          String      @id @default(uuid())
  userId      String
  postId      String?
  commentId   String?
  createdAt   DateTime    @default(now())

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  post        Post?       @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment     Comment?    @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@unique([userId, commentId])
  @@index([postId])
  @@index([commentId])
  @@map("likes")
  @@schema("identity_schema")
}

model Category {
  id          String      @id @default(uuid())
  name        String      @unique
  slug        String      @unique
  description String?
  icon        String?
  color       String?     @default("#0ea5e9")
  createdAt   DateTime    @default(now())

  // Relations
  posts       Post[]

  @@map("categories")
  @@schema("identity_schema")
}

model Tag {
  id          String      @id @default(uuid())
  name        String      @unique
  slug        String      @unique
  createdAt   DateTime    @default(now())

  // Relations
  posts       PostTag[]

  @@map("tags")
  @@schema("identity_schema")
}

model PostTag {
  postId      String
  tagId       String

  post        Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag         Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
  @@map("post_tags")
  @@schema("identity_schema")
}

// ==================== JOB MODELS ====================

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  FREELANCE

  @@schema("identity_schema")
}

enum JobLevel {
  ENTRY
  JUNIOR
  MID
  SENIOR
  LEAD
  MANAGER
  DIRECTOR

  @@schema("identity_schema")
}

enum ApplicationStatus {
  PENDING
  REVIEWED
  SHORTLISTED
  INTERVIEW
  OFFERED
  ACCEPTED
  REJECTED

  @@schema("identity_schema")
}

model Job {
  id              String          @id @default(uuid())
  companyId       String?
  postedBy        String
  title           String
  description     String          @db.Text
  requirements    String          @db.Text
  responsibilities String         @db.Text
  type            JobType
  level           JobLevel
  location        String
  isRemote        Boolean         @default(false)
  salaryMin       Int?
  salaryMax       Int?
  salaryCurrency  String          @default("IDR")
  skills          String[]
  benefits        String[]
  applicationUrl  String?
  isActive        Boolean         @default(true)
  viewCount       Int             @default(0)
  applicationCount Int            @default(0)
  deadline        DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  poster          User            @relation("JobPoster", fields: [postedBy], references: [id], onDelete: Cascade)
  company         Company?        @relation(fields: [companyId], references: [id], onDelete: SetNull)
  applications    Application[]
  savedJobs       SavedJob[]

  @@index([postedBy])
  @@index([companyId])
  @@index([isActive])
  @@index([type])
  @@index([level])
  @@index([createdAt])
  @@schema("identity_schema")
}

model Company {
  id              String          @id @default(uuid())
  name            String
  description     String?         @db.Text
  website         String?
  logo            String?
  industry        String?
  size            String?
  location        String?
  founded         Int?
  createdBy       String?         // Add this field
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  jobs            Job[]
  creator         User?           @relation("CompanyCreator", fields: [createdBy], references: [id], onDelete: SetNull)


  @@index([createdBy])
  @@schema("identity_schema")
}

model Application {
  id              String              @id @default(uuid())
  jobId           String
  userId          String
  coverLetter     String?             @db.Text
  resumeUrl       String?
  portfolioUrl    String?
  status          ApplicationStatus   @default(PENDING)
  notes           String?             @db.Text
  appliedAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  job             Job                 @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([jobId, userId])
  @@index([userId])
  @@index([status])
  @@schema("identity_schema")
}

model SavedJob {
  id              String          @id @default(uuid())
  jobId           String
  userId          String
  savedAt         DateTime        @default(now())

  // Relations
  job             Job             @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([jobId, userId])
  @@index([userId])
  @@schema("identity_schema")
}

// ==================== EVENT MODELS ====================

enum EventType {
  WEBINAR
  WORKSHOP
  MEETUP
  REUNION
  SEMINAR
  NETWORKING
  CONFERENCE

  @@schema("identity_schema")
}

enum EventStatus {
  DRAFT
  PENDING_APPROVAL
  PUBLISHED
  ONGOING
  COMPLETED
  CANCELLED
  REJECTED

  @@schema("identity_schema")
}

enum RegistrationStatus {
  REGISTERED
  CONFIRMED
  ATTENDED
  CANCELLED

  @@schema("identity_schema")
}

model Event {
  id              String              @id @default(uuid())
  organizerId     String
  title           String
  description     String              @db.Text
  type            EventType
  status          EventStatus         @default(PUBLISHED)
  coverImage      String?
  startDate       DateTime
  endDate         DateTime
  location        String
  isOnline        Boolean             @default(false)
  meetingUrl      String?
  capacity        Int?
  currentAttendees Int                @default(0)
  price           Int                 @default(0)
  currency        String              @default("IDR")
  tags            String[]
  requirements    String?             @db.Text
  agenda          String?             @db.Text
  speakers        Json?
  viewCount       Int                 @default(0)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  // Approval fields
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?             @db.Text

  // Relations
  organizer       User                @relation("EventOrganizer", fields: [organizerId], references: [id], onDelete: Cascade)
  registrations   Registration[]

  @@index([organizerId])
  @@index([status])
  @@index([type])
  @@index([startDate])
  @@schema("identity_schema")
}

model Registration {
  id              String              @id @default(uuid())
  eventId         String
  userId          String
  status          RegistrationStatus  @default(REGISTERED)
  notes           String?             @db.Text
  attendedAt      DateTime?
  registeredAt    DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  event           Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([userId])
  @@index([status])
  @@schema("identity_schema")
}
